{% extends "base.html" %}

{% block content %}
<section class="video-upload-section d-flex align-items-center justify-content-center" style="height: 80vh;">
  <div class="container text-center">
    <h2 class="mb-4">Upload a Video for Summarization</h2>
    <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
      <div class="form-group mb-3">
        <input type="file" id="videoFile" name="file" accept="video/*" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">Upload Video</button>
    </form>
    <div id="summaryContainer" class="mt-4">
      <h3>Audio-Visual Summary:</h3>
      <p id="summaryText">Waiting for summary...</p>
    </div>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('videoFile');
    const summaryText = document.getElementById('summaryText');

    // Pass the authentication status from Flask to JavaScript
    const isAuthenticated = {{ "true" if current_user.is_authenticated else "false" }};

    uploadForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // Prevent default form submission

        if (!isAuthenticated) {
            alert("You must be logged in to upload a video.");
            window.location.href = "/login";  // Redirect to login page
            return;
        }

        // Prepare the form data
        let formData = new FormData();
        formData.append('file', fileInput.files[0]);

        // Show a loading message
        summaryText.textContent = "Processing video and generating summary...";

        try {
            // Use fetch to POST the file to your /upload route
            let response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            // Expect a JSON response with a "summary" key
            let data = await response.json();
            if (data.summary) {
                summaryText.textContent = data.summary;
            } else {
                summaryText.textContent = "No summary returned.";
            }
        } catch (error) {
            console.error('Error:', error);
            summaryText.textContent = "Error processing video.";
        }
    });
});
</script>

{% endblock %}
